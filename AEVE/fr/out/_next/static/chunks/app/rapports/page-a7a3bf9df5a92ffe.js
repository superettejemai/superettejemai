(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[754],{12905:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s={src:"/_next/static/media/dinar.1f6d249a.png",height:512,width:512,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAMAAADz0U65AAAAIVBMVEVLS0s9Pj87PD0/QUE7Oz09P0A8PD09Pj48PD89PUA9PT0VozlBAAAAC3RSTlMESpIUcihrOFwxdAstonUAAAAJcEhZcwAACxIAAAsSAdLdfvwAAAA2SURBVHicFcu5EcAwDMAwUo8le/+Bc0EPwF0B9sycha6ErEavjuLJ6T5yw0zjQkVE1N98T/gAHs0A0ZVGh5sAAAAASUVORK5CYII=",blurWidth:8,blurHeight:8}},34200:(e,t,a)=>{"use strict";a.d(t,{default:()=>I});var s=a(95155),r=a(12115),o=a(36959),i=a(35137),l=a(5772),n=a(12905);let d=e=>null==e||isNaN(e)?"0.00":e.toFixed(3),c=e=>null==e||isNaN(e)?"0":e.toString(),x=({statsData:e})=>{let t=e||{totalCost:0,totalRevenue:0,totalProfit:0,totalOrders:0,totalQuantitySold:0,period:{startDate:new Date().toISOString().split("T")[0],endDate:new Date().toISOString().split("T")[0],isSingleDay:!1},filter:{}},a=[{title:"Ventes Totales",value:`${d(t.totalRevenue)} DT`,icon:(0,s.jsx)(l.default,{src:n.A.src,className:"w-11 h-10",width:11,height:10,alt:"Dinar Logo"}),color:"text-gray-500",description:"Chiffre d'affaires total"},{title:"Transactions",value:c(t.totalOrders),icon:(0,s.jsx)(o.PPg,{className:"w-6 h-6"}),color:"text-gray-500",description:"Nombre total de commandes"},{title:"Produits Vendus",value:c(t.totalQuantitySold),icon:(0,s.jsx)(o.VUU,{className:"w-6 h-6"}),color:"text-gray-500",description:"Quantit\xe9 totale vendue"},{title:"Profit Net",value:`${d(t.totalProfit)} DT`,icon:(0,s.jsx)(o.Bm9,{className:"w-6 h-6"}),color:"text-gray-500",description:"B\xe9n\xe9fice apr\xe8s co\xfbts"}];return(0,s.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8",children:a.map((e,t)=>(0,s.jsxs)("div",{className:"bg-white border border-gray-200 p-4 sm:p-6 flex justify-between items-start transition-shadow",children:[(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-500 mb-2",children:e.title}),(0,s.jsx)("p",{className:"text-xl sm:text-2xl font-bold text-gray-900 mb-1",children:e.value}),(0,s.jsx)("p",{className:"text-xs text-gray-400",children:e.description})]}),(0,s.jsx)("div",{className:`${e.color} rounded-md p-2`,children:e.icon})]},t))})};var m=a(79848),h=a(68518);let u={control:e=>({...e,minHeight:"54px",borderColor:"#A2ACBC",borderRadius:"0",boxShadow:"none","&:hover":{borderColor:"#d1d5db"},"&:focus-within":{borderColor:"#6b7280",outline:"none",boxShadow:"0 0 0 1px #6b7280"}}),option:(e,t)=>({...e,borderRadius:"0",backgroundColor:t.isFocused?"#f3f4f6":"white",color:"#1f2937",padding:"18px 22px",fontSize:"0.875rem",textTransform:"capitalize"}),singleValue:e=>({...e,color:"#1f2937",fontSize:"0.875rem",textTransform:"capitalize"}),placeholder:e=>({...e,color:"#9ca3af",fontSize:"0.875rem"}),menu:e=>({...e,zIndex:60,borderRadius:"0"}),menuList:e=>({...e,maxHeight:"220px",overflowY:"auto"})};function p({isOpen:e,onClose:t,onApply:a,userRole:o}){let[i,l]=(0,r.useState)([]),[n,d]=(0,r.useState)([]),[c,x]=(0,r.useState)([]),[p,g]=(0,r.useState)(null),[f,y]=(0,r.useState)({dateRange:"today",fromDate:"",toDate:"",category:"",selectedProduct:""});(0,r.useEffect)(()=>{e&&(b(),j(),y({dateRange:"today",fromDate:"",toDate:"",category:"",selectedProduct:""}),g(null))},[e]);let b=async()=>{try{let e=localStorage.getItem("authToken");if(!e)return;let t=await fetch("http://localhost:4000/api/products",{headers:{Authorization:`Bearer ${e}`}}),a=await t.json(),s=a.products||a.data?.products||[],r=await fetch("http://localhost:4000/api/stats/categories",{headers:{Authorization:`Bearer ${e}`}}),o=await r.json(),i=o.data||o.categories||[];l(s),d(i)}catch(e){console.error("Error fetching products and categories:",e)}},j=async()=>{try{let e=localStorage.getItem("authToken");if(!e)return;let t=await fetch("http://localhost:4000/api/users",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!t.ok)throw Error("Failed to fetch users");let a=await t.json(),s=(a.users||a||[]).filter(e=>"worker"===e.role||"admin"===e.role);x(s)}catch(e){console.error("Error fetching cashiers:",e)}};if(!e)return null;let N=[{value:"today",label:"Aujourd'hui"},{value:"yesterday",label:"Hier"},{value:"custom",label:"Personnalis\xe9"}],w=n.map(e=>({value:e,label:e})),v=i.map(e=>({value:e.id.toString(),label:`${e.name} - ${e.barcode}`})),D=c.map(e=>({value:e.id,label:`${e.name} (${e.role})`}));return(0,s.jsx)("div",{className:"fixed inset-0 bg-black/90 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg p-6 w-full max-w-4xl  overflow-y-auto",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,s.jsx)("h2",{className:"text-xl font-bold text-gray-900",children:"Filtrer les Statistiques"}),(0,s.jsx)("button",{onClick:t,className:"text-gray-400 hover:text-gray-600",children:(0,s.jsx)(h.A,{className:"w-5 h-5"})})]}),(0,s.jsxs)("form",{onSubmit:e=>{e.preventDefault();let s={};if("today"===f.dateRange){let e=new Date().toISOString().split("T")[0];s.startDate=e,s.endDate=e}else if("yesterday"===f.dateRange){let e=new Date;e.setDate(e.getDate()-1);let t=e.toISOString().split("T")[0];s.startDate=t,s.endDate=t}else"custom"===f.dateRange&&f.fromDate&&f.toDate&&(s.startDate=f.fromDate,s.endDate=f.toDate);if(f.selectedProduct){let e=i.find(e=>e.id===Number(f.selectedProduct));e&&(s.productName=e.name)}else f.category&&(s.category=f.category);p?.value&&(s.cashierId=p.value),a(s),t()},className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"P\xe9riode"}),(0,s.jsx)(m.Ay,{options:N,value:N.find(e=>e.value===f.dateRange),onChange:e=>y({...f,dateRange:e?.value||"today"}),styles:u,isSearchable:!1,menuPlacement:"auto",menuPosition:"fixed"})]}),"custom"===f.dateRange&&(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Date de d\xe9but"}),(0,s.jsx)("input",{type:"date",value:f.fromDate,onChange:e=>y({...f,fromDate:e.target.value}),className:"w-full px-4 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-500 focus:border-transparent text-sm",required:!0})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Date de fin"}),(0,s.jsx)("input",{type:"date",value:f.toDate,onChange:e=>y({...f,toDate:e.target.value}),className:"w-full px-4 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-500 focus:border-transparent text-sm",required:!0})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Filtrer par Caissier"}),(0,s.jsx)(m.Ay,{options:D,value:p,onChange:g,placeholder:"Tous les caissiers",styles:u,isClearable:!0,menuPlacement:"auto",menuPosition:"fixed"}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"S\xe9lectionnez un caissier pour filtrer le rapport."})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Cat\xe9gorie"}),(0,s.jsx)(m.Ay,{options:w,value:w.find(e=>e.value===f.category)||null,onChange:e=>{y({...f,category:e?.value||"",selectedProduct:""})},placeholder:"Toutes les cat\xe9gories",styles:u,isClearable:!0,menuPlacement:"auto",menuPosition:"fixed"}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"S\xe9lectionnez une cat\xe9gorie pour filtrer les produits."})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Produit sp\xe9cifique"}),(0,s.jsx)(m.Ay,{options:v,value:v.find(e=>e.value===f.selectedProduct)||null,onChange:e=>{y({...f,selectedProduct:e?.value||"",category:""})},placeholder:"Tous les produits",styles:u,isClearable:!0,menuPlacement:"auto",menuPosition:"fixed"}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"S\xe9lectionnez un produit sp\xe9cifique pour un rapport d\xe9taill\xe9."})]}),(0,s.jsxs)("div",{className:"flex gap-3 pt-4 pb-6",children:[(0,s.jsx)("button",{type:"button",onClick:t,className:"flex-1 px-4 py-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium",children:"Annuler"}),(0,s.jsx)("button",{type:"submit",className:"flex-1 px-4 py-4 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium",children:"Appliquer les filtres"})]})]})]})})}var g=a(1728),f=a(80865),y=a(53201),b=a(67389),j=a(65671),N=a(96647);let w=({statsData:e})=>{let t=e.totalCost??0,a=[{name:"Profit",value:e.totalProfit??0,color:"#65738D"},{name:"Co\xfbt",value:t,color:"#a2adbd"}].filter(e=>e.value>0);return 0===a.length?(0,s.jsx)("div",{style:{width:"100%",height:300},className:"flex items-center justify-center",children:(0,s.jsx)("p",{className:"text-gray-500",children:"Aucune donn\xe9e \xe0 afficher"})}):(0,s.jsx)("div",{style:{width:"100%",height:300},children:(0,s.jsx)(g.u,{children:(0,s.jsxs)(f.r,{children:[(0,s.jsx)(y.F,{data:a,cx:"50%",cy:"50%",labelLine:!1,label:({name:e,percent:t})=>`${e} (${(100*(t||0)).toFixed(1)}%)`,outerRadius:80,fill:"#8884d8",dataKey:"value",children:a.map((e,t)=>(0,s.jsx)(b.f,{fill:e.color},`cell-${t}`))}),(0,s.jsx)(j.m,{formatter:e=>[`${(e??0).toFixed(3)} DT`,"Montant"]}),(0,s.jsx)(N.s,{})]})})})};var v=a(51292),D=a(28408),S=a(32539),T=a(59656),C=a(55035);let F=({statsData:e})=>{let t=e.totalRevenue??0,a=e.totalProfit??0,r=e.totalCost??0;return(0,s.jsx)("div",{style:{width:"100%",height:300},children:(0,s.jsx)(g.u,{children:(0,s.jsxs)(v.E,{data:[{name:"Performance",Revenue:t,Profit:a,Cost:r}],children:[(0,s.jsx)(D.d,{strokeDasharray:"3 3"}),(0,s.jsx)(S.W,{dataKey:"name"}),(0,s.jsx)(T.h,{}),(0,s.jsx)(j.m,{formatter:e=>[`${(e??0).toFixed(3)} DT`,""]}),(0,s.jsx)(N.s,{}),(0,s.jsx)(C.y,{dataKey:"Revenue",fill:"#334055",name:"Revenu Total"}),(0,s.jsx)(C.y,{dataKey:"Profit",fill:"#65738D",name:"Profit"}),(0,s.jsx)(C.y,{dataKey:"Cost",fill:"#a2adbd",name:"Co\xfbt"})]})})})};var A=a(18831);class P{static async exportToPDF(e,t){try{let a=new A.Ay("p","mm","a4");return this.addHeader(a,e),this.addMetricsSection(a,e),this.addProfitChart(a,e),this.addPerformanceChart(a,e),this.addFooter(a),a.save(`${t}.pdf`),!0}catch(e){return console.error("PDF export error:",e),!1}}static addHeader(e,t){e.setFillColor(59,130,246),e.rect(0,0,210,60,"F"),e.setTextColor(255,255,255),e.setFontSize(24),e.setFont("helvetica","bold");let a="Rapport des Statistiques",s=e.getTextWidth(a);e.text(a,(210-s)/2,25),e.setFontSize(12),e.setFont("helvetica","normal");let r=t?.period?.startDate&&t?.period?.endDate?`P\xe9riode: ${new Date(t.period.startDate).toLocaleDateString()} - ${new Date(t.period.endDate).toLocaleDateString()}`:"P\xe9riode: Non sp\xe9cifi\xe9e",o=e.getTextWidth(r);e.text(r,(210-o)/2,35);let i="Toutes les cat\xe9gories";t?.filter?.category?i=`Cat\xe9gorie: ${t.filter.category}`:t?.filter?.productName&&(i=`Produit: ${t.filter.productName}`);let l=e.getTextWidth(i);e.text(i,(210-l)/2,42)}static addMetricsSection(e,t){e.setTextColor(0,0,0),e.setFontSize(16),e.setFont("helvetica","bold"),e.text("M\xe9triques Cl\xe9s",20,75),[{label:"Revenu Total",value:`${this.safeToFixed(t?.totalRevenue)} DT`,color:[34,197,94]},{label:"Profit Net",value:`${this.safeToFixed(t?.totalProfit)} DT`,color:[59,130,246]},{label:"Commandes",value:(t?.totalOrders??0).toString(),color:[168,85,247]},{label:"Quantit\xe9 Vendue",value:(t?.totalQuantitySold??0).toString(),color:[249,115,22]}].forEach((t,a)=>{let s=20+a%2*85,r=90+25*Math.floor(a/2);e.setFillColor(t.color[0],t.color[1],t.color[2]),e.roundedRect(s,r,75,20,3,3,"F"),e.setTextColor(255,255,255),e.setFontSize(10),e.setFont("helvetica","bold"),e.text(t.label,s+5,r+8),e.setFontSize(12),e.text(t.value,s+5,r+15)})}static addProfitChart(e,t){e.setTextColor(0,0,0),e.setFontSize(16),e.setFont("helvetica","bold"),e.text("R\xe9partition des Revenus",20,150),e.setDrawColor(200,200,200),e.setFillColor(250,250,250),e.roundedRect(20,155,170,80,3,3,"FD");let a=t?.totalRevenue||1,s=(t?.totalProfit??0)/a*100,r=(t?.totalCost??0)/a*100,o=170*s/100;if(e.setFillColor(34,197,94),e.roundedRect(25,175,o-10,30,2,2,"F"),e.setFillColor(239,68,68),e.roundedRect(25+o,175,170-o-10,30,2,2,"F"),e.setTextColor(255,255,255),e.setFontSize(10),e.setFont("helvetica","bold"),o>40){let t=`PROFIT ${s.toFixed(1)}%`,a=e.getTextWidth(t);e.text(t,25+(o-10)/2-a/2,193)}if(170-o>40){let t=`CO\xdbT ${r.toFixed(1)}%`,a=e.getTextWidth(t);e.text(t,25+o+(170-o-10)/2-a/2,193)}e.setTextColor(0,0,0),e.setFontSize(11),e.setFont("helvetica","normal"),e.text(`Profit: ${this.safeToFixed(t.totalProfit)} DT`,25,220),e.text(`Co\xfbt: ${this.safeToFixed(t.totalCost)} DT`,25,230);let i=`Marge: ${s.toFixed(1)}%`,l=e.getTextWidth(i);e.text(i,120+(50-l)/2,225)}static addPerformanceChart(e,t){e.setTextColor(0,0,0),e.setFontSize(16),e.setFont("helvetica","bold"),e.text("Analyse de Performance",20,250),e.setDrawColor(200,200,200),e.setFillColor(250,250,250),e.roundedRect(20,255,170,80,3,3,"FD");let a=Math.max(t?.totalRevenue??0,t?.totalProfit??0,t?.totalCost??0),s=a>0?60/a:1;e.setFillColor(59,130,246);let r=(t?.totalRevenue??0)*s;e.rect(30,325-r,40,r,"F"),e.setFillColor(34,197,94);let o=(t?.totalProfit??0)*s;e.rect(85,325-o,40,o,"F"),e.setFillColor(239,68,68);let i=(t?.totalCost??0)*s;e.rect(140,325-i,40,i,"F"),e.setTextColor(0,0,0),e.setFontSize(9),e.setFont("helvetica","normal");let l="Revenu",n=e.getTextWidth(l);e.text(l,50-n/2,333);let d="Profit",c=e.getTextWidth(d);e.text(d,105-c/2,333);let x="Co\xfbt",m=e.getTextWidth(x);if(e.text(x,160-m/2,333),e.setTextColor(255,255,255),e.setFontSize(8),e.setFont("helvetica","bold"),r>15){let a=this.safeToFixed(t?.totalRevenue),s=e.getTextWidth(a);e.text(a,50-s/2,325-r+12)}if(o>15){let a=this.safeToFixed(t?.totalProfit),s=e.getTextWidth(a);e.text(a,105-s/2,325-o+12)}if(i>15){let a=this.safeToFixed(t?.totalCost),s=e.getTextWidth(a);e.text(a,160-s/2,325-i+12)}e.setTextColor(100,100,100),e.setFontSize(10),e.text("DT",15,280),e.text("â†‘",15,285)}static addFooter(e){let t=e.internal.pageSize.height;e.setFillColor(249,250,251),e.rect(0,t-30,210,30,"F"),e.setTextColor(100,100,100),e.setFontSize(10),e.setFont("helvetica","normal"),e.text(`G\xe9n\xe9r\xe9 le ${new Date().toLocaleDateString("fr-FR")}`,20,t-15);let a="Syst\xe8me de Point de Vente - Rapport Automatis\xe9",s=e.getTextWidth(a);e.text(a,(210-s)/2,t-15);let r="Page 1/1",o=e.getTextWidth(r);e.text(r,210-o-20,t-15)}static exportToCSV(e,t){try{let a=[["Revenu Total",this.safeToFixed(e.totalRevenue),"DT"],["Co\xfbt Total",this.safeToFixed(e.totalCost),"DT"],["Profit Total",this.safeToFixed(e.totalProfit),"DT"],["Nombre de Commandes",e.totalOrders.toString(),""],["Quantit\xe9 Vendue",e.totalQuantitySold.toString(),""],["Date de D\xe9but",e.period.startDate,""],["Date de Fin",e.period.endDate,""],["Filtre",e.filter.category||e.filter.productName||"Toutes les donn\xe9es",""]],s="data:text/csv;charset=utf-8,";s+="M\xe9trique,Valeur,Unit\xe9\n",a.forEach(e=>{s+=e.join(",")+"\n"});let r=encodeURI(s),o=document.createElement("a");return o.setAttribute("href",r),o.setAttribute("download",`${t}.csv`),document.body.appendChild(o),o.click(),document.body.removeChild(o),!0}catch(e){return console.error("CSV export error:",e),!1}}static getExportFilename(e){let t=new Date().toISOString().split("T")[0],a="statistiques";return e.filter.category?a=`statistiques-${this.sanitizeFilename(e.filter.category)}`:e.filter.productName&&(a=`statistiques-${this.sanitizeFilename(e.filter.productName)}`),`${a}-${t}`}static sanitizeFilename(e){return e.replace(/[^a-z0-9]/gi,"_").toLowerCase()}static safeToFixed(e){return null==e||isNaN(e)?"0.00":e.toFixed(3)}}let k=({statsData:e,onExport:t})=>{let[a,o]=(0,r.useState)(null),l=async a=>{if(e){o(a);try{let s=P.getExportFilename(e),r=!1;switch(a){case"pdf":r=await P.exportToPDF(e,s);break;case"csv":r=P.exportToCSV(e,s)}r?t(a):alert(`Erreur lors de l'export ${a.toUpperCase()}`)}catch(e){console.error("Export error:",e),alert(`Erreur lors de l'export ${a.toUpperCase()}`)}finally{o(null)}}};return(0,s.jsxs)("div",{className:"bg-white border border-gray-200 p-6 mb-8",children:[(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-xl font-bold text-gray-900",children:e?e.filter.category?`Analyse - Cat\xe9gorie: ${e.filter.category}`:e.filter.productName?`Analyse - Produit: ${e.filter.productName}`:"Analyse des Performances - Toutes les donn\xe9es":"Analyse des Performances"}),e&&(0,s.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:(()=>{if(!e)return"";let t=new Date(e.period.startDate).toLocaleDateString(),a=new Date(e.period.endDate).toLocaleDateString();return e.period.isSingleDay?`Donn\xe9es du ${t}`:`P\xe9riode: ${t} - ${a}`})()})]}),e&&(0,s.jsxs)("div",{className:"flex gap-2 mt-4 sm:mt-0",children:[(0,s.jsxs)("button",{onClick:()=>l("pdf"),disabled:null!==a,className:"flex items-center gap-2 px-3 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:[(0,s.jsx)(i.a4x,{className:"w-4 h-4"}),"pdf"===a?"Export...":"PDF"]}),(0,s.jsxs)("button",{onClick:()=>l("csv"),disabled:null!==a,className:"flex items-center gap-2 px-3 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:[(0,s.jsx)(i.a4x,{className:"w-4 h-4"}),"csv"===a?"Export...":"CSV"]})]})]}),e?(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{className:"bg-white border border-gray-300 p-4",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-800 mb-4",children:"R\xe9partition des Revenus"}),(0,s.jsx)(w,{statsData:e})]}),(0,s.jsxs)("div",{className:"bg-white border border-gray-300 p-4",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-800 mb-4",children:e.period.isSingleDay?"D\xe9tails de la Journ\xe9e":"Aper\xe7u des Performances"}),(0,s.jsx)(F,{statsData:e})]})]}):(0,s.jsx)("div",{className:"text-center text-gray-500 py-12",children:(0,s.jsx)("p",{children:"Chargement des donn\xe9es statistiques..."})}),a&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,s.jsx)("div",{className:"bg-white p-6 rounded-lg shadow-lg",children:(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900"}),(0,s.jsxs)("p",{className:"text-gray-700",children:["G\xe9n\xe9ration du fichier ",a.toUpperCase(),"..."]})]})})})]})},E=({isOpen:e,onClose:t,transaction:a,orderItems:l})=>{let[n,d]=(0,r.useState)(!1),[c,x]=(0,r.useState)(null);if(!e||!a)return null;let m=parseFloat(a.total_amount.replace(" DT","")),h=async()=>{if(a){d(!0),x(null);try{let e=localStorage.getItem("authToken");if(!e)throw Error("Token d'authentification non trouv\xe9");let t={id:a.original_id,paid_amount:parseFloat(a.paid_amount.replace(" DT","")),change_amount:parseFloat(a.change_amount.replace(" DT","")),payment_method:a.payment_method,note:a.note,created_at:new Date().toISOString(),user_id:a.user_id,total:m,tax:0},s=l.map(e=>({name:e.product_name,price:e.unit_price,quantity:e.quantity,product_id:e.product_id,total_price:e.total_price})),r=await fetch("http://localhost:4000/api/print",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({order:t,cartItems:s})});if(!r.ok){let e=await r.json();throw Error(e.message||"\xc9chec de l'impression")}let o=await r.json();if(o.success)console.log("âœ… Ticket imprim\xe9 avec succ\xe8s via le backend");else throw Error(o.message||"\xc9chec de l'impression")}catch(e){console.error("âŒ Erreur d'impression:",e),x(e instanceof Error?e.message:"Une erreur est survenue lors de l'impression")}finally{d(!1)}}};return(0,s.jsx)("div",{className:"fixed inset-0 bg-black/90 bg-opacity-50 flex items-center justify-center p-4 z-50",children:(0,s.jsxs)("div",{className:"bg-white max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[(0,s.jsxs)("div",{dir:"ltr",className:"bg-white text-black p-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-start",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-xl font-bold",children:"Ticket de Facture"}),(0,s.jsxs)("p",{className:"text-gray-700 mt-1",children:["Transaction #",a.id]})]}),(0,s.jsx)("button",{onClick:t,className:"text-gray-600 hover:text-black text-2xl rounded-full bg-gray-300 p-2",children:(0,s.jsx)(o.fUT,{className:"w-4 h-4"})})]}),(0,s.jsxs)("div",{className:"mt-4 grid grid-cols-2 gap-4 text-sm",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-gray-600",children:"Date"}),(0,s.jsx)("p",{children:a.date})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-gray-600",children:"Caissier"}),(0,s.jsx)("p",{children:a.cashier})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-gray-600",children:"M\xe9thode de Paiement"}),(0,s.jsx)("p",{children:a.payment_method})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-gray-600",children:"Statut"}),(0,s.jsx)("p",{children:a.status})]})]})]}),(0,s.jsxs)("div",{dir:"ltr",className:"p-6",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold mb-4",children:"Produits Achet\xe9s"}),0===l.length?(0,s.jsx)("p",{className:"text-gray-500 text-center py-4",children:"Aucun produit pour cette facture"}):(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"grid grid-cols-12 gap-2 text-sm font-medium text-gray-600 border-b border-dashed border-gray-300 pb-2",children:[(0,s.jsx)("div",{className:"col-span-6",children:"Produit"}),(0,s.jsx)("div",{className:"col-span-2 text-center",children:"Quantit\xe9"}),(0,s.jsx)("div",{className:"col-span-2 text-right",children:"Prix Unitaire"}),(0,s.jsx)("div",{className:"col-span-2 text-right",children:"Total"})]}),l.map(e=>(0,s.jsxs)("div",{className:"grid grid-cols-12 gap-2 text-sm border-b border-gray-300 pb-3",children:[(0,s.jsxs)("div",{className:"col-span-6",children:[(0,s.jsx)("p",{className:"font-medium",children:e.product_name}),e.product_barcode&&(0,s.jsxs)("p",{className:"flex items-center text-xs text-gray-500",children:[(0,s.jsx)(o.wbn,{className:"w-5 h-5"}),e.product_barcode]}),e.product_category&&(0,s.jsxs)("p",{className:"flex items-center gap-2 text-xs text-gray-500",children:["Cat\xe9gorie: ",e.product_category]})]}),(0,s.jsx)("div",{className:"col-span-2 text-center",children:(0,s.jsx)("span",{className:"bg-gray-100 px-2 py-1 rounded-full",children:e.quantity})}),(0,s.jsxs)("div",{className:"col-span-2 text-right",children:[e.unit_price.toFixed(3)," DT"]}),(0,s.jsxs)("div",{className:"col-span-2 text-right font-medium",children:[e.total_price.toFixed(3)," DT"]})]},e.id)),(0,s.jsxs)("div",{className:"space-y-2 pt-4 border-t border-dashed border-gray-300",children:[(0,s.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,s.jsx)("span",{children:"Sous-total:"}),(0,s.jsxs)("span",{children:[l.reduce((e,t)=>e+t.total_price,0).toFixed(3)," DT"]})]}),(0,s.jsxs)("div",{className:"flex justify-between font-bold text-lg border-t border-dashed border-gray-300 pt-2",children:[(0,s.jsx)("span",{children:"Total:"}),(0,s.jsxs)("span",{children:[m.toFixed(3)," DT"]})]}),(0,s.jsxs)("div",{className:"flex justify-between text-sm text-green-600",children:[(0,s.jsx)("span",{children:"Montant Pay\xe9:"}),(0,s.jsx)("span",{children:a.paid_amount})]}),(0,s.jsxs)("div",{className:"flex justify-between text-sm text-zinc-900",children:[(0,s.jsx)("span",{children:"Monnaie Rendu:"}),(0,s.jsx)("span",{children:a.change_amount})]})]}),a.note&&(0,s.jsxs)("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-yellow-800",children:"Note:"}),(0,s.jsx)("p",{className:"text-sm text-yellow-700",children:a.note})]})]})]}),(0,s.jsx)("div",{className:"bg-gray-50 p-4 rounded-b-lg border-t",children:(0,s.jsxs)("div",{className:"flex justify-end gap-2",children:[c&&(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)("p",{className:"text-red-600 text-sm",children:c})}),(0,s.jsx)("button",{onClick:h,disabled:n,className:"flex items-center gap-2 px-4 py-2 bg-gray-800 text-white hover:bg-gray-700 disabled:bg-gray-400 rounded transition-colors",children:n?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Impression en cours..."]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.jH2,{className:"w-4 h-4"}),"Imprimer le Ticket"]})})]})})]})})},$=()=>{let[e,t]=(0,r.useState)([]),[a,o]=(0,r.useState)([]),[l,n]=(0,r.useState)([]),[d,c]=(0,r.useState)(!0),[x,m]=(0,r.useState)(null),[h,u]=(0,r.useState)(""),[p,g]=(0,r.useState)(1),[f]=(0,r.useState)(5),[y,b]=(0,r.useState)(new Map),[j,N]=(0,r.useState)(null),[w,v]=(0,r.useState)([]),[D,S]=(0,r.useState)(!1),[T,C]=(0,r.useState)(null),F=async()=>{try{let e=localStorage.getItem("authToken");if(!e)throw Error("Token d'authentification non trouv\xe9");let t=await fetch("http://localhost:4000/api/users",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!t.ok)throw Error(`\xc9chec de la r\xe9cup\xe9ration des utilisateurs: ${t.status}`);let a=await t.json(),s=new Map;return(a.users||a.workers||a||[]).forEach(e=>{s.set(e.id,e)}),console.log(`âœ… [fetchUsers] Created users map with ${s.size} users`),s}catch(e){return console.error("âŒ [fetchUsers] Erreur lors de la r\xe9cup\xe9ration des utilisateurs:",e),new Map}},A=async e=>{try{let t=localStorage.getItem("authToken");if(!t)throw Error("Token d'authentification non trouv\xe9");let a=await fetch(`http://localhost:4000/api/orders/${e}/items`,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!a.ok){if(404===a.status)return[];throw await a.text(),Error(`\xc9chec de la r\xe9cup\xe9ration des d\xe9tails de la commande: ${a.status}`)}let s=await a.json();return s.success&&s.items?s.items:[]}catch(e){return console.error("Erreur lors de la r\xe9cup\xe9ration des d\xe9tails de la commande:",e),[]}},P=async e=>{S(!0),C(null),N(e);try{let t=await A(e.original_id);v(t),0===t.length&&C("Aucun d\xe9tail pour cette transaction")}catch(e){console.error("Erreur lors du chargement des d\xe9tails:",e),C("Une erreur est survenue lors du chargement des d\xe9tails"),v([])}finally{S(!1)}},k=()=>{N(null),v([]),C(null)};(0,r.useEffect)(()=>{(async()=>{try{c(!0),m(null);let e=localStorage.getItem("authToken");if(!e)throw Error("Token d'authentification non trouv\xe9");let a=await F();b(a);let s=await fetch("http://localhost:4000/api/orders",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!s.ok)throw Error(`\xc9chec de la r\xe9cup\xe9ration des commandes: ${s.status}`);let r=await s.json();if(!r.success)throw Error(r.message||"\xc9chec de la r\xe9cup\xe9ration des commandes");console.log("\uD83D\uDCE6 [fetchOrdersAndUsers] Processing orders:",r.orders);let i=r.orders.map(e=>{let t=a.get(e.user_id);console.log(`ðŸ”„ [fetchOrdersAndUsers] Order ${e.id} - User ID: ${e.user_id}, Found user:`,t);let s=t?t.name:`Utilisateur ${e.user_id}`;return console.log(`âœ… [fetchOrdersAndUsers] Order ${e.id} - Cashier name: ${s}`),{id:`T${e.id.toString().padStart(3,"0")}`,date:new Date(e.created_at).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),cashier:s,total_amount:`${e.total.toFixed(3)} DT`,paid_amount:`${e.paid_amount.toFixed(3)} DT`,change_amount:`${e.change_amount.toFixed(3)} DT`,payment_method:"cash"===e.payment_method?"Esp\xe8ces":"card"===e.payment_method?"Carte":e.payment_method||"Autre",status:"Compl\xe9t\xe9e",original_id:e.id,user_id:e.user_id,note:e.note}});t(i),o(i),console.log("\uD83C\uDF89 [fetchOrdersAndUsers] Successfully transformed transactions")}catch(e){console.error("âŒ [fetchOrdersAndUsers] Erreur lors de la r\xe9cup\xe9ration des commandes:",e),m(e instanceof Error?e.message:"Une erreur est survenue lors du chargement des transactions"),t([]),o([])}finally{c(!1)}})()},[]),(0,r.useEffect)(()=>{if(!h.trim()){o(e),g(1);return}let t=h.toLowerCase();o(e.filter(e=>e.id.toLowerCase().includes(t)||e.cashier.toLowerCase().includes(t)||e.total_amount.toLowerCase().includes(t)||e.paid_amount.toLowerCase().includes(t)||e.payment_method.toLowerCase().includes(t)||e.original_id.toString().includes(t)||e.user_id.toString().includes(t))),g(1)},[h,e]),(0,r.useEffect)(()=>{let e=p*f;n(a.slice(e-f,e))},[p,a,f]);let $=Math.ceil(a.length/f);return((0,r.useEffect)(()=>{g(1)},[a]),d)?(0,s.jsxs)("div",{className:"bg-white border border-gray-200 shadow-sm overflow-hidden",children:[(0,s.jsx)("div",{className:"p-4 sm:p-6 border-b border-gray-200",children:(0,s.jsx)("h3",{className:"text-lg sm:text-xl font-semibold text-gray-900",children:"Historique des Transactions"})}),(0,s.jsxs)("div",{className:"p-8 text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"}),(0,s.jsx)("p",{className:"text-gray-600 mt-2",children:"Chargement des transactions..."})]})]}):x?(0,s.jsxs)("div",{className:"bg-white border border-gray-200 shadow-sm overflow-hidden",children:[(0,s.jsx)("div",{className:"p-4 sm:p-6 border-b border-gray-200",children:(0,s.jsx)("h3",{className:"text-lg sm:text-xl font-semibold text-gray-900",children:"Historique des Transactions"})}),(0,s.jsxs)("div",{className:"p-8 text-center",children:[(0,s.jsx)("p",{className:"text-red-600 mb-4",children:x}),(0,s.jsx)("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-700",children:"R\xe9essayer"})]})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{dir:"ltr",className:"bg-white border border-gray-200 shadow-sm overflow-hidden",children:[(0,s.jsxs)("div",{className:"p-4 sm:p-6 border-b border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[(0,s.jsx)("h3",{className:"text-2xl font-bold text-gray-900",children:"Historique des Transactions"}),(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row gap-4 items-center",children:[(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(i.CKj,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),(0,s.jsx)("input",{type:"text",placeholder:"Rechercher par num\xe9ro de transaction, caissier, montant...",value:h,onChange:e=>u(e.target.value),className:"pl-10 pr-4 py-4 border border-gray-300 focus:outline-none focus:ring-1 focus:ring-gray-500 focus:border-transparent w-full sm:w-64 text-sm"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("button",{onClick:()=>p>1&&g(p-1),disabled:1===p,className:"p-4 border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,s.jsx)(i.irw,{className:"w-5 h-5"})}),(0,s.jsxs)("div",{className:"text-sm text-gray-600 min-w-20 text-center",children:["Page ",p," sur ",$]}),(0,s.jsx)("button",{onClick:()=>p<$&&g(p+1),disabled:p===$||0===$,className:"p-4 border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,s.jsx)(i.fOo,{className:"w-5 h-5"})})]})]})]}),(0,s.jsxs)("div",{className:"overflow-x-auto",children:[(0,s.jsxs)("table",{className:"w-full min-w-full",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsx)("tr",{children:["Num\xe9ro de Transaction","Date et Heure","Caissier","Montant Total","Montant Pay\xe9","Monnaie Rendu","M\xe9thode de Paiement","Statut","D\xe9tails"].map((e,t)=>(0,s.jsx)("th",{className:"px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap",children:e},t))})}),(0,s.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:l.map((e,t)=>(0,s.jsxs)("tr",{className:"hover:bg-gray-50 transition-colors",children:[(0,s.jsx)("td",{className:"px-4 sm:px-6 py-4 text-sm font-bold text-gray-900 whitespace-nowrap",children:e.id}),(0,s.jsx)("td",{className:"px-4 sm:px-6 py-4 text-sm text-gray-600 whitespace-nowrap",children:e.date}),(0,s.jsx)("td",{className:"px-4 sm:px-6 py-4 text-sm text-gray-700 whitespace-nowrap",children:e.cashier}),(0,s.jsx)("td",{className:"px-4 sm:px-6 py-4 text-sm font-medium text-gray-900 whitespace-nowrap",children:e.total_amount}),(0,s.jsx)("td",{className:"px-4 sm:px-6 py-4 text-sm font-medium text-gray-900 whitespace-nowrap",children:e.paid_amount}),(0,s.jsx)("td",{className:"px-4 sm:px-6 py-4 text-sm font-medium text-gray-900 whitespace-nowrap",children:e.change_amount}),(0,s.jsx)("td",{className:"px-4 sm:px-6 py-4 text-sm text-gray-700 whitespace-nowrap",children:e.payment_method}),(0,s.jsx)("td",{className:"px-4 sm:px-6 py-4 text-sm whitespace-nowrap",children:(0,s.jsx)("span",{className:"inline-flex px-4 py-4 text-xs font-semibold bg-green-100 text-black",children:e.status})}),(0,s.jsx)("td",{className:"px-4 sm:px-6 py-4 text-sm whitespace-nowrap",children:(0,s.jsxs)("button",{onClick:()=>P(e),className:"flex items-center gap-1 px-4 py-4 bg-zinc-800 text-white hover:bg-zinc-900 transition-colors text-xs",title:"Voir les d\xe9tails de la transaction",children:[(0,s.jsx)(i.jH2,{className:"w-3 h-3"}),"Ticket"]})})]},t))})]}),0===a.length&&(0,s.jsx)("div",{className:"text-center py-8",children:(0,s.jsx)("p",{className:"text-gray-500",children:h?"Aucune transaction correspondant \xe0 votre recherche":"Aucune transaction"})}),a.length>0&&(0,s.jsx)("div",{className:"px-4 sm:px-6 py-3 bg-gray-50 border-t border-gray-200",children:(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["Affichage de ",(p-1)*f+1," \xe0 ",Math.min(p*f,a.length)," sur ",a.length," transaction",a.length>1?"s":""]})})]})]}),(0,s.jsx)(E,{isOpen:!!j,onClose:k,transaction:j,orderItems:w}),D&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg p-6 text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-zinc-900 mx-auto"}),(0,s.jsx)("p",{className:"text-gray-600 mt-2",children:"Chargement des d\xe9tails..."})]})}),T&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-sm mx-4 text-center",children:[(0,s.jsx)("div",{className:"w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,s.jsx)("svg",{className:"w-6 h-6 text-yellow-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Information"}),(0,s.jsx)("p",{className:"text-gray-600 mb-4",children:T}),(0,s.jsx)("button",{onClick:k,className:"px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-700",children:"Fermer"})]})})]})},_=()=>(0,s.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 sm:h-16 sm:w-16 border-b-2 border-gray-900 mx-auto"}),(0,s.jsx)("p",{className:"mt-4 text-gray-600 text-sm sm:text-base",children:"Chargement des statistiques..."})]})});function R({isOpen:e,onClose:t,products:a,period:r}){if(!e)return null;let o=a.reduce((e,t)=>e+(t.total_quantity||0),0),l=a.reduce((e,t)=>e+(t.total_revenue||0),0),n=a.reduce((e,t)=>e+(t.total_profit||0),0);return(0,s.jsxs)("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:[(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 transition-opacity",onClick:t}),(0,s.jsx)("div",{className:"flex min-h-full items-center justify-center p-4",children:(0,s.jsxs)("div",{className:"relative bg-white rounded-lg shadow-xl w-full max-w-5xl",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-4 border-b",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(i.est,{className:"w-5 h-5 text-blue-600"}),(0,s.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"Produits Vendus"})]}),(0,s.jsx)("button",{onClick:t,className:"text-gray-400 hover:text-gray-500 transition-colors",children:(0,s.jsx)(i.yGN,{className:"w-5 h-5"})})]}),(0,s.jsxs)("div",{className:"px-4 py-3 bg-gray-50 border-b",children:[(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["P\xe9riode: ",new Date(r.startDate).toLocaleDateString()," - ",new Date(r.endDate).toLocaleDateString()]}),(0,s.jsxs)("div",{className:"flex gap-4 mt-1",children:[(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["Total produits vendus: ",(0,s.jsx)("span",{className:"font-semibold",children:o})]}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["Chiffre d'affaires: ",(0,s.jsxs)("span",{className:"font-semibold",children:[l.toFixed(2)," TND "]})]}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["B\xe9n\xe9fice: ",(0,s.jsxs)("span",{className:`font-semibold ${n>=0?"text-green-600":"text-red-600"}`,children:[n.toFixed(2)," TND"]})]})]})]}),(0,s.jsx)("div",{className:"p-4 max-h-[60vh] overflow-y-auto",children:0===a.length?(0,s.jsx)("div",{className:"text-center py-8 text-gray-500",children:"Aucun produit vendu sur cette p\xe9riode"}):(0,s.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Produit"}),(0,s.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Cat\xe9gorie"}),(0,s.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Quantit\xe9"}),(0,s.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Prix moyen"}),(0,s.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Chiffre d'affaires"}),(0,s.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"B\xe9n\xe9fice"})]})}),(0,s.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:a.map((e,t)=>(0,s.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,s.jsx)("td",{className:"px-4 py-3 text-sm text-gray-900 font-medium",children:e.product_name||"N/A"}),(0,s.jsx)("td",{className:"px-4 py-3 text-sm text-gray-600",children:e.product_category||"N/A"}),(0,s.jsx)("td",{className:"px-4 py-3 text-sm text-gray-900",children:e.total_quantity||0}),(0,s.jsxs)("td",{className:"px-4 py-3 text-sm text-gray-600",children:[(e.avg_price||0).toFixed(2)," TND"]}),(0,s.jsxs)("td",{className:"px-4 py-3 text-sm text-gray-900",children:[(e.total_revenue||0).toFixed(2)," TND"]}),(0,s.jsxs)("td",{className:`px-4 py-3 text-sm font-medium ${(e.total_profit||0)>=0?"text-green-600":"text-red-600"}`,children:[(e.total_profit||0).toFixed(2)," TND"]})]},e.product_id||t))})]})}),(0,s.jsx)("div",{className:"border-t px-4 py-3 flex justify-end gap-2",children:(0,s.jsx)("button",{onClick:t,className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors",children:"Fermer"})})]})})]})}function I(){let[e,t]=(0,r.useState)(!1),[a,l]=(0,r.useState)(!1),[n,d]=(0,r.useState)(null),[c,m]=(0,r.useState)(!0),[h,u]=(0,r.useState)(null),[g,f]=(0,r.useState)(null),[y,b]=(0,r.useState)(null),[j,N]=(0,r.useState)(!1),[w,v]=(0,r.useState)([]),[D,S]=(0,r.useState)(!1);(0,r.useEffect)(()=>{T(),C()},[]),(0,r.useEffect)(()=>{h&&F(h)},[h]);let T=async()=>{try{let e=localStorage.getItem("authToken");if(!e)return;let t=await fetch("http://localhost:4000/api/users/me",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(t.ok){let e=await t.json();f(e.user.role)}}catch(e){console.error("Error fetching user role:",e)}},C=async()=>{let e=new Date().toISOString().split("T")[0];try{m(!0),b(null);let t=localStorage.getItem("authToken");if(!t)throw Error("Authentication token not found");let a=new URLSearchParams;a.append("startDate",e),a.append("endDate",e);let s=await fetch(`http://localhost:4000/api/stats/products?${a.toString()}`,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!s.ok){let e=await s.text();throw console.error("Stats API error:",e),Error(`Failed to fetch stats: ${s.status}`)}let r=await s.json();if(r.success&&r.data)d(r.data);else throw Error(r.message||"Invalid response format")}catch(t){console.error("Error fetching default stats:",t),b(t instanceof Error?t.message:"Unknown error"),d({totalCost:0,totalRevenue:0,totalProfit:0,totalOrders:0,totalQuantitySold:0,period:{startDate:e,endDate:e,isSingleDay:!0},filter:{}})}finally{m(!1)}},F=async e=>{try{m(!0),b(null);let t=localStorage.getItem("authToken");if(!t)throw Error("Authentication token not found");let a=new URLSearchParams;e.startDate&&a.append("startDate",e.startDate),e.endDate&&a.append("endDate",e.endDate),e.productName&&a.append("productName",e.productName),e.category&&a.append("category",e.category),e.cashierId&&a.append("cashierId",e.cashierId.toString());let s=await fetch(`http://localhost:4000/api/stats/products?${a.toString()}`,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!s.ok)throw await s.text(),Error(`Failed to fetch stats: ${s.status}`);let r=await s.json();if(r.success&&r.data)d(r.data);else throw Error(r.message||"Invalid response format")}catch(e){console.error("Error fetching stats:",e),b(e instanceof Error?e.message:"Unknown error")}finally{m(!1)}},A=async()=>{try{N(!0);let e=localStorage.getItem("authToken");if(!e)throw Error("Authentication token not found");let t=new URLSearchParams;if(h?.startDate&&h?.endDate)t.append("startDate",h.startDate),t.append("endDate",h.endDate);else{let e=new Date().toISOString().split("T")[0];t.append("startDate",e),t.append("endDate",e)}h?.category&&t.append("category",h.category),h?.productName&&t.append("productName",h.productName),h?.cashierId&&t.append("cashierId",h.cashierId.toString());let a=await fetch(`http://localhost:4000/api/stats/detailed-report?${t.toString()}`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!a.ok){let e=await a.json();throw Error(e.message||`Failed to fetch report: ${a.status}`)}let s=await a.json();if(!s.success||!s.data)throw Error("Invalid report data");let r=await fetch("http://localhost:4000/api/print-sales-report",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({reportData:s.data})});if(!r.ok){let e=await r.json();throw Error(e.message||"Failed to print report")}let o=await r.json();console.log("âœ… Report printed successfully:",o.message)}catch(e){console.error("Error printing report:",e),alert(e instanceof Error?e.message:"Erreur lors de l'impression du rapport")}finally{N(!1)}},P=async()=>{try{S(!0);let e=localStorage.getItem("authToken");if(!e)throw Error("Authentication token not found");let t=new URLSearchParams;if(h?.startDate&&h?.endDate)t.append("startDate",h.startDate),t.append("endDate",h.endDate);else{let e=new Date().toISOString().split("T")[0];t.append("startDate",e),t.append("endDate",e)}h?.category&&t.append("category",h.category),h?.productName&&t.append("productName",h.productName),h?.cashierId&&t.append("cashierId",h.cashierId.toString());let a=await fetch(`http://localhost:4000/api/stats/detailed-report?${t.toString()}`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!a.ok){let e=await a.json();throw Error(e.message||`Failed to fetch report: ${a.status}`)}let s=await a.json();if(s.success&&s.data){let e=E(s.data);v(e),l(!0)}else throw Error("Invalid report data")}catch(e){console.error("Error fetching products sold:",e),alert(e instanceof Error?e.message:"Erreur lors du chargement des produits")}finally{S(!1)}},E=e=>{if(e.products&&Array.isArray(e.products))return e.products;if(e.transactions&&Array.isArray(e.transactions)){let t=[];return e.transactions.forEach(e=>{e.items&&Array.isArray(e.items)&&e.items.forEach(a=>{t.push({id:a.productId||a.id,name:a.productName||a.name,category:a.category||"N/A",quantity:a.quantity||0,price:a.price||0,total:(a.price||0)*(a.quantity||0),cashierName:e.cashierName,saleDate:e.createdAt||e.date,transactionId:e.id})})}),t}return Array.isArray(e)?e:(console.warn("Could not extract products from report data structure:",e),[])},I="worker"===g;return c?(0,s.jsx)(_,{}):(0,s.jsx)("div",{className:"min-h-screen bg-white",children:(0,s.jsxs)("div",{className:"max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[y&&(0,s.jsxs)("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-md",children:[(0,s.jsx)("p",{className:"font-medium",children:"Erreur de chargement des statistiques"}),(0,s.jsx)("p",{className:"text-sm",children:y}),(0,s.jsx)("button",{onClick:C,className:"mt-2 px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700",children:"R\xe9essayer"})]}),(0,s.jsxs)("div",{className:`mb-8 ${I?"filter blur-sm pointer-events-none":""}`,children:[(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 mb-2",children:"Tableau de bord des Rapports"}),(0,s.jsx)("p",{className:"text-gray-600 text-sm sm:text-base",children:h?"Statistiques filtr\xe9es":"Statistiques globales du mois en cours"}),n?.period&&(0,s.jsxs)("p",{className:"text-sm text-gray-500 mt-1",children:["P\xe9riode: ",new Date(n.period.startDate).toLocaleDateString()," - ",new Date(n.period.endDate).toLocaleDateString()]}),h?.cashierId&&(0,s.jsxs)("p",{className:"text-sm text-blue-600 mt-1",children:["Filtr\xe9 par caissier: ",h.cashierName||"ID: "+h.cashierId]})]}),(0,s.jsxs)("div",{className:"flex gap-2 flex-wrap",children:[h&&(0,s.jsx)("button",{onClick:()=>{u(null),b(null),C()},className:"flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 transition-colors shadow-sm",children:(0,s.jsx)("span",{className:"text-sm font-medium",children:"Aujourd'hui"})}),(0,s.jsxs)("button",{onClick:()=>t(!0),className:"flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 transition-colors shadow-sm",children:[(0,s.jsx)(o.slq,{className:"w-4 h-4"}),(0,s.jsx)("span",{className:"text-sm font-medium",children:h?"Modifier Filtres":"Filtrer Statistiques"})]}),(0,s.jsx)("button",{onClick:P,disabled:D,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-400 transition-colors shadow-sm",children:D?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),(0,s.jsx)("span",{className:"text-sm font-medium",children:"Chargement..."})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.est,{className:"w-4 h-4"}),(0,s.jsx)("span",{className:"text-sm font-medium",children:"Voir Produits Vendus"})]})}),(0,s.jsx)("button",{onClick:A,disabled:j,className:"flex items-center gap-2 px-4 py-2 bg-green-700 text-white hover:bg-green-700 disabled:bg-green-400 transition-colors shadow-sm",children:j?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),(0,s.jsx)("span",{className:"text-sm font-medium",children:"Impression..."})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.jH2,{className:"w-4 h-4"}),(0,s.jsx)("span",{className:"text-sm font-medium",children:"Imprimer Rapport Total"})]})})]})]}),(0,s.jsx)(x,{statsData:n}),(0,s.jsx)(k,{statsData:n,onExport:e=>{console.log("Exporting in format:",e)}})]}),(0,s.jsx)("div",{className:I?"":"mt-8",children:(0,s.jsx)($,{})}),(0,s.jsx)("div",{className:I?"filter blur-sm pointer-events-none":"",children:(0,s.jsx)(p,{isOpen:e,onClose:()=>t(!1),onApply:e=>{u(e)}})}),(0,s.jsx)(R,{isOpen:a,onClose:()=>l(!1),products:w,period:{startDate:h?.startDate||new Date().toISOString().split("T")[0],endDate:h?.endDate||new Date().toISOString().split("T")[0]}})]})})}},40504:(e,t,a)=>{Promise.resolve().then(a.bind(a,34200))}},e=>{e.O(0,[87,844,33,930,772,619,848,933,441,794,358],()=>e(e.s=40504)),_N_E=e.O()}]);